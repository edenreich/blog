version: '3.7'

services:
  ingress:
    build: 
      context: .
      dockerfile: ops/docker/ingress/Dockerfile
    volumes:
    - ./ops/docker/helpers/openssl/certs:/etc/nginx/certs:ro
    ports:
    - 80:80
    - 443:443
    networks: 
    - app
    depends_on: 
    - openssl
    
  frontend:
    build:
      context: .
      dockerfile: ops/docker/frontend/Dockerfile
    environment:
      NODE_ENV: ${APP_ENV}
      MAILGUN_DOMAIN: ${MAILGUN_DOMAIN}
      MAILGUN_API_KEY: ${MAILGUN_API_KEY}
    command: sh -c "yarn && yarn dev"
    volumes:
    - ./src/frontend:/app:rw
    networks: 
    - app

  admin:
    build:
      context: .
      dockerfile:  ops/docker/admin/Dockerfile
    environment: 
      NODE_ENV: ${APP_ENV}
    command: sh -c "yarn && yarn develop"
    volumes:
    - ./src/admin:/app:rw
    networks: 
    - app
  
  openssl:
    build:
      context: .
      dockerfile: ops/docker/helpers/openssl/Dockerfile
    volumes:
    - ./ops/docker/helpers/openssl/certs:/root/certs:rw


networks:
  app: